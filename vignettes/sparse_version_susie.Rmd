---
title: "Sparse Version Susie"
author: "Kaiqian Zhang"
date: "7/24/2018"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
Note: sparse version R code is under `sparse-matrix` branch of susieR repo. Please feel free to review it and make comments. Thanks!!!

```{r, warning=FALSE}
devtools::install_local("/Users/kaiqianzhang/Desktop/M/M-github-repos/susieR")
```

```{r}
library(susieR)
library(Matrix)
library(ggplot2)
library(microbenchmark)
library(profvis)
```

## Simulate a matrix with sparsity 0.99
```{r}
#' @title simulate a binary n by p matrix X with certain sparsity
#' @param sparsity a double between 0 and 1
#' @param n an int nrow of matrix X
#' @param p an int ncol of matrix X
create_sparsity_mat = function(sparsity, n, p){
  set.seed(1)
  nonzero = round(n*p*(1-sparsity))
  nonzero.idx = sample(n*p, nonzero)
  mat = numeric(n*p)
  mat[nonzero.idx] = 1
  mat = matrix(mat, nrow=n, ncol=p)
  return(mat)     
}
```

```{r}
set.seed(1)
n = 1000
p = 1000
beta = rep(0,p)
beta[1] = 10 
beta[300] = 10
beta[400] = 10
beta[1000] = 10
#Two versions of X input: dense & sparse
#Matrix X is of 0.99 sparsity
X.dense = create_sparsity_mat(0.99, n, p)
X.sparse = as(X.dense, 'dgCMatrix')
y = X.dense %*% beta + rnorm(n)
```

## Use `profvis` to evaluate computational time line by line
`profvis` shows that for a 1000 by 1000 matrix, dense version susie needs 1410ms and sparse version susie needs 1020ms. We can also take a close look at those profiles for each function and discuss which step could be improved. 
```{r}
profvis({
  susie.dense.fit = susie(X.dense,y)
})
```

```{r}
profvis({
  susie.sparse.fit = susie(X.sparse,y)
})
```

## Microbenchmark visualization
```{r, warning=FALSE}
sparse.dense.test = microbenchmark(
  susie.sparse = susie(X.sparse,y),
  susie.dense = susie(X.dense,y),
  times=30
)
autoplot(sparse.dense.test)
```

## Verify sparse version susie results by plotting effects
```{r}
susie.dense.fit = susie(X.dense,y)
susie.sparse.fit = susie(X.sparse,y)
```

```{r}
plot(coef(susie.dense.fit))
```

```{r}
plot(coef(susie.sparse.fit))
```